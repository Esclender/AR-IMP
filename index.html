<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>AR</title>
  </head>
  <link ty >

  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <script type="module" src="./getItemsFromApi.js"></script>
  
  <script>
  
    function renderScene(imgsIds) {
      const root = document.querySelector('#root')
      const sceneElement = document.createElement("a-scene");
      const assets = document.createElement("a-assets");

      sceneElement.setAttribute("scene", "");
      sceneElement.setAttribute("vr-mode-ui", "enabled: false;");
      sceneElement.setAttribute("renderer", "antialias: true; alpha: true; precision: mediump;");
      sceneElement.setAttribute("embedded", "");
      sceneElement.setAttribute("arjs", "trackingMethod: best; sourceType: webcam; debugUIEnabled: false;");


      // Iterate through the array of image IDs and create video elements
      imgsIds.forEach(({id, urlVideo}) => {
          const videoElement = document.createElement("video");
          videoElement.setAttribute("src", `${urlVideo}`);
          videoElement.setAttribute("preload", "auto");
          videoElement.setAttribute("id", `${id.toLowerCase()}`);
          videoElement.setAttribute("loop", "");
          videoElement.setAttribute("crossorigin", "anonymus");

          // Append the video element to the assets
          assets.appendChild(videoElement);
      })
      
      sceneElement.appendChild(assets)

      imgsIds.forEach(({id, url, urlDescriptor}) => {
          const aVideo = document.createElement("a-video")
          const nftElement = document.createElement("a-nft");

          aVideo.setAttribute("src", `#${id.toLowerCase()}`);
          aVideo.setAttribute("rotation", {x:-90 , y: 0, z: 0});
          aVideo.setAttribute("position",{x:90 , y: 0, z: -260} );
          aVideo.setAttribute("width", "170");
          aVideo.setAttribute("height", "340");
          aVideo.setAttribute("id", `a-video-${id}`);


          nftElement.setAttribute(`${id.toLowerCase()}`, "");
          nftElement.setAttribute("type", "nft");
          nftElement.setAttribute("url", `./data/${id}/${id}`);
          nftElement.setAttribute("smooth", "true");
          nftElement.setAttribute("smoothount", "10");
          nftElement.setAttribute("smoothtolerance", "0.01");
          nftElement.setAttribute("smooththreshold", "5");

          nftElement.appendChild(aVideo);
          sceneElement.appendChild(nftElement);
      })

      root.appendChild(sceneElement);
      
    }

    function registerComponents(imgsIds) {

      imgsIds.map(({id}) => {

      return AFRAME.registerComponent(id.toLowerCase(), {
        init: function() {
          var marker = this.el;
          this.vid = document.querySelector(`#${id.toLowerCase()}`)
          this.avid = document.querySelector(`#a-video-${id}`)

          marker.addEventListener(
            "markerFound",
            function() {
              this.vid.play();
            }.bind(this)
          );

          marker.addEventListener(
            "markerLost",
            function() {
              this.vid.pause();
              this.vid.currentTime = 0;
            }.bind(this)
          );
        },
      });
      })

      
    }
  </script>
  
  <script>

    window.onload = function() {
      fetch('./data/imgsIds.json')
        .then((res) => {
          return res.json()
        })
        .then((json) => {
          renderScene(json)
          registerComponents(json);
        })
    };

  </script>
  
  <body id="root"  style="margin : 0px; overflow: hidden;">
    <div class="arjs-loader">
      <div>Loading, please wait...</div>
    </div>

    
</body>
</html>
