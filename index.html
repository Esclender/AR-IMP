<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>AR</title>
</head>
<link ty>

<script
  src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

<script>

  window.onload = async () => {

    //const url = "http://localhost:4001/api/galerias/virtuales/descriptors"
    const url = "https://npz-test-galeria-virtual.s3.us-west-2.amazonaws.com/api/galerias/virtuales/descriptors"

    const response = await fetch(url);
    const virtualItems = await response.json();
    console.log(virtualItems);
    const video = document.querySelector("#video");
    const sceneElement = document.querySelector("#a-scene");
    const messagesElement = document.querySelector("#messages");
    virtualItems.forEach(virtualItem => {
      const aVideo = document.createElement("a-video")
      const nftElement = document.createElement("a-nft");
      const msgElement = document.createElement("p");
      virtualItem.componentNft = `nft${virtualItem.id.toLowerCase().replace(/[^0-9a-z]+/gi, '')}`;
      virtualItem.componentVideo = `video${virtualItem.id.toLowerCase().replace(/[^0-9a-z]+/gi, '')}`;
      virtualItem.message = `msg${virtualItem.id.toLowerCase().replace(/[^0-9a-z]+/gi, '')}`;
      aVideo.setAttribute("src", `#video`);
      aVideo.setAttribute("rotation", {x:-90 , y: 0, z: 0});
      aVideo.setAttribute("position",{x:0 , y: 0, z: 0} );
      aVideo.setAttribute("width", "17"*5);
      aVideo.setAttribute("height", "34"*5);
      aVideo.setAttribute("id", `${virtualItem.componentVideo}`);

      
      nftElement.setAttribute(`${virtualItem.componentNft}`, "");
      nftElement.setAttribute("type", "nft");
      nftElement.setAttribute("url", `${virtualItem.urlDescriptor}`);
      nftElement.setAttribute("smooth", "false");
      nftElement.setAttribute("emitevents", "true");
      nftElement.setAttribute("smoothount", "1");
      nftElement.setAttribute("smoothtolerance", "0");
      nftElement.setAttribute("smooththreshold", "0");

      nftElement.appendChild(aVideo);
      sceneElement.appendChild(nftElement);

      msgElement.setAttribute('id', virtualItem.message)
      msgElement.innerHTML = 'Found ' + virtualItem.id
      msgElement.setAttribute('style', 'display: none')
      messagesElement.appendChild(msgElement);

      AFRAME.registerComponent(`${virtualItem.componentNft}`, {
        update: function() {console.log(`update ${virtualItem.id}`)},
        remove: function() {console.log(`remove ${virtualItem.id}`)},
        tick: function() {
          //console.log(`tick ${virtualItem.id}`)
        },
        tock: function() {
          //console.log(`tock ${virtualItem.id}`)
        },
        play: function() {console.log(`play ${virtualItem.id}`)},
        pause: function() {console.log(`pause ${virtualItem.id}`)},
        updateSchema: function() {console.log(`updateSchema ${virtualItem.id}`)},
        init: function () {
          console.log(`init ${virtualItem.id}`)

          var marker = this.el;
          marker.addEventListener(
            "markerFound",
            function () {
              console.log(`found ${virtualItem.id}`)
              msgElement.setAttribute('style', 'display: block')

              video.setAttribute('src', virtualItem.urlVideo)
              video.play();
            }
          );

          marker.addEventListener(
            "markerLost",
            function () {
              console.log(`lost ${virtualItem.id}`)
              msgElement.setAttribute('style', 'display: none')

              video.pause();
              video.currentTime = 0;
            }
          );
        }
      });
    })
    window.addEventListener("arjs-nft-loaded", (event) => {
      console.log("Finlilyy")
      console.log(event)
    });
  };

</script>

<body id="root" style="margin : 0px; overflow: hidden;">
  <div style="position: absolute;z-index: 10;color: white;font-size: 50px;top: 0;" id="messages">
  </div>
  <div class="arjs-loader">
    <div>Cargando por favor espere</div>
  </div>

  <a-scene vr-mode-ui="enabled: false;" renderer="antialias: true; alpha: true; precision: mediump;" embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;" id="a-scene">
    <a-assets>
      <video src="https://npz-test-galeria-virtual.s3.us-west-2.amazonaws.com/alumnos/Alumno+01.mp4" preload="auto" id="video" response-type="arraybuffer" loop crossorigin="anonymous"></video>
    </a-assets>

    <a-entity camera></a-entity>
  </a-scene>
  

</body>

</html>